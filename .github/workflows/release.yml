name: Release Runnable Apps

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-package:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      # 1. Prepare Version
      - name: Prepare Release Version
        shell: bash
        run: |
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          CLEAN_VERSION=${CURRENT_VERSION//-SNAPSHOT/}
          echo "APP_VERSION=$CLEAN_VERSION" >> $GITHUB_ENV
          mvn versions:set -DnewVersion=$CLEAN_VERSION -DgenerateBackupPoms=false

      # 2. Build & Install
      - name: Build with Maven
        run: mvn -B clean install -DskipTests --file pom.xml

      # 3. Copy dependencies
      - name: Copy dependencies
        run: mvn dependency:copy-dependencies --file impl/pom.xml

      # 4. Debug & Bundle
      - name: Prepare bundle directory
        shell: bash
        run: |
          echo "Listing target directory for debugging:"
          ls -R impl/target
          
          mkdir -p impl/target/bundle
          
          cp impl/target/avro-viewer-app-impl-*.jar impl/target/bundle/
          
          cp impl/target/dependency/*.jar impl/target/bundle/

      # 5. jpackage stage
      - name: Run jpackage
        shell: bash
        run: |
          MAIN_JAR="avro-viewer-app-impl-${{ env.APP_VERSION }}.jar"
          APP_NAME="AvroViewer"
          
          if [ "$RUNNER_OS" == "Windows" ]; then
            TYPE="app-image"
            ICON="impl/src/main/resources/icon.ico"
            EXTRA_ARGS="--win-console"
            OUTPUT_NAME="AvroViewer-Windows"
          elif [ "$RUNNER_OS" == "macOS" ]; then
            TYPE="app-image"
            ICON="impl/src/main/resources/icon.icns"
            EXTRA_ARGS=""
            OUTPUT_NAME="AvroViewer-macOS"
          else
            TYPE="app-image"
            ICON="impl/src/main/resources/icon.png"
            EXTRA_ARGS=""
            OUTPUT_NAME="AvroViewer-Linux"
          fi

          jpackage \
            --type $TYPE \
            --name "$APP_NAME" \
            --app-version "${{ env.APP_VERSION }}" \
            --input "impl/target/bundle" \
            --main-jar "$MAIN_JAR" \
            --main-class "com.dkostin.avro_viewer.app.Main" \
            --dest "dist" \
            --module-path "impl/target/dependency" \
            --add-modules javafx.controls,javafx.fxml,javafx.graphics \
            --java-options "--enable-native-access=javafx.graphics" \
            --java-options "--add-opens=java.base/sun.nio.ch=ALL-UNNAMED" \
            --icon "$ICON" \
            --verbose \
            $EXTRA_ARGS

          cd dist
          mv "$APP_NAME" "$OUTPUT_NAME"

      # 6. Archive
      - name: Archive Release
        shell: bash
        run: |
          cd dist
          if [ "$RUNNER_OS" == "Windows" ]; then
            NAME="AvroViewer-Windows-${{ env.APP_VERSION }}.zip"
            7z a "$NAME" "AvroViewer-Windows"
          elif [ "$RUNNER_OS" == "macOS" ]; then
             NAME="AvroViewer-macOS-${{ env.APP_VERSION }}.zip"
             zip -r "$NAME" "AvroViewer-macOS.app" 
          else
             NAME="AvroViewer-Linux-${{ env.APP_VERSION }}.zip"
             zip -r "$NAME" "AvroViewer-Linux"
          fi
          echo "ARTIFACT_PATH=dist/$NAME" >> $GITHUB_ENV

      # 7. Upload
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.ARTIFACT_PATH }}